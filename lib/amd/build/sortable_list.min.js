define(["jquery","core/log","core/autoscroll","core/str","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){var g,h,i,j={listSelector:null,moveHandlerSelector:null,isHorizontal:!1,destinationNameCallback:null,elementNameCallback:null,moveDialogueTitleCallback:null},k={keyboardDragClass:"dragdrop-keyboard-drag",isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",overElementClass:"sortable-list-over-element"},l={},m={},n=0,o=function(){var b=a(l.listSelector);b.children().removeClass(l.isDraggedClass).removeClass(l.currentPositionClass).removeClass(l.overElementClass),b.removeClass(l.targetListClass).removeClass(l.sourceListClass)},p=function(b){if(b.originalEvent&&b.originalEvent.touches&&void 0!==b.originalEvent.touches[0]){var c=b.originalEvent.touches[0];b.pageX=c.pageX,b.pageY=c.pageY}void 0===b.pageX?(b.pageX=i.pageX,b.pageY=i.pageY):i=b,void 0===b.clientX&&(b.clientX=Math.round(b.pageX-a(window).scrollLeft()),b.clientY=Math.round(b.pageY-a(window).scrollTop()))},q=function(b){l=b.data.params,o(),p(b);var d=a(b.currentTarget);if(null===l.moveHandlerSelector||a(b.target).closest(l.moveHandlerSelector,d).length){b.stopPropagation(),b.preventDefault(),n++,m={draggedElement:d,sourceNextElement:d.next(),sourceList:d.parent(),targetNextElement:d.next(),targetList:d.parent(),type:b.type,dropped:!1,startX:b.pageX,startY:b.pageY,startTime:(new Date).getTime()},a(l.listSelector).addClass(l.targetListClass);var e=d.offset();d.addClass(l.currentPositionClass),h={x:e.left-b.pageX,y:e.top-b.pageY},g=a();var f=n;setTimeout(function(){null!==m&&"click"!==m.type&&n===f&&r()},500),a("body").on("mousemove touchmove mouseup touchend",v),a("body").on("keypress",z),c.start(function(){a("body").trigger("mousemove")}),y("dragstart")}},r=function(){g=m.draggedElement.clone(),m.sourceList.append(g),g.removeAttr("id").removeClass(l.currentPositionClass).addClass(l.isDraggedClass).css({position:"fixed"}),g.offset({top:h.y+i.pageY,left:h.x+i.pageX})},s=function(b){b.preventDefault(),b.stopPropagation(),l=b.data.params;var c=a(b.currentTarget).closest(l.listSelector),d=c.children().filter(function(){return a.contains(this,b.currentTarget)});d.length&&(n++,m={draggedElement:d,sourceNextElement:d.next(),sourceList:c,targetNextElement:d.next(),targetList:c,dropped:!1,type:b.type,startTime:(new Date).getTime()},y("dragstart"),F())},t=function(a,b,c){if(!c.length)return null;var d=c[0],e=0,f=d.getBoundingClientRect(),g=b-(f.top+window.scrollY),h=a-(f.left+window.scrollX);return h>=-e&&h<=f.width+e&&g>=-e&&g<=f.height+e?{x:h,y:g,xRatio:f.width?h/f.width:0,yRatio:f.height?g/f.height:0}:null},u=function(){return!g||!g.length||this!==g[0]},v=function(b){p(b),g.offset({top:-1e3,left:-1e3});var c=a(document.elementFromPoint(b.clientX,b.clientY)),d=c.closest("."+l.targetListClass+" > :not(."+l.isDraggedClass+")"),e=c.closest("."+l.targetListClass);if(a("."+l.overElementClass).removeClass(l.overElementClass),d.addClass(l.overElementClass),g.offset({top:h.y+b.pageY,left:h.x+b.pageX}),e.length&&!e.children().filter(u).length)w(e,a());else if(1===d.length){var f=t(b.pageX,b.pageY,d);if(f){var i=d.parent(),j=l.isHorizontal?f.xRatio:f.yRatio;j>.5?w(i,d.next().filter(u)):w(i,d)}}"mouseup"!==b.type&&"touchend"!==b.type||(m.endX=b.pageX,m.endY=b.pageY,m.endTime=(new Date).getTime(),m.dropped=!0,y("drop"),x())},w=function(a,b){var c=m.draggedElement;b.length&&b[0]===c[0]||a[0]===m.targetList[0]&&b.length===m.targetNextElement.length&&b[0]===m.targetNextElement[0]||(b.length?a[0].insertBefore(c[0],b[0]):g&&g.parent().length&&g.parent()[0]===a[0]?a[0].insertBefore(c[0],g[0]):a[0].appendChild(c[0]),m.targetList=a,m.targetNextElement=b,y("drag"))},x=function(){o(),c.stop(),a("body").off("mousemove touchmove mouseup touchend",v),a("body").off("keypress",z),g&&(g.remove(),g=a()),y("dragend"),m=null},y=function(a){m.draggedElement.trigger("sortablelist-"+a,m)},z=function(a){"keypress"===a.type&&27===a.originalEvent.keyCode&&(w(m.sourceList,m.sourceNextElement),x())},A=function(b){var c=b;return"object"==typeof b&&b.hasOwnProperty("then")||(c=a.Deferred(),c.resolve(b)),c},B=function(a){if(l.elementNameCallback){var b=l.elementNameCallback(a);if(null!==b)return A(b)}return A(a.text())},C=function(a,b){if(l.destinationNameCallback){var c=l.destinationNameCallback(a,b);if(null!==c)return A(c)}return b.length?B(b).then(function(a){return d.get_string("movecontentafter","moodle",a)}):d.get_string("movecontenttothetop","moodle")},D=function(a){if(l.moveDialogueTitleCallback){var b=l.moveDialogueTitleCallback(a);if(null!==b)return A(b)}return B(a).then(function(a){return d.get_string("movecontent","moodle",a)})},E=function(b){var c=a(l.listSelector),d=a("<ul/>").addClass(l.keyboardDragClass),e=function(c,e,f){if(!e.is(m.draggedElement)&&!f.is(m.draggedElement)){var g=a("<li/>").appendTo(d),h=a('<a href="#"/>').click(function(a){a.preventDefault(),a.stopPropagation(),w(c,e),m.endTime=(new Date).getTime(),m.dropped=!0,y("drop"),b.hide()}).appendTo(g);C(c,f).then(function(a){h.text(a)})}};return c.each(function(){var b=a(this),c=b.children();b.children().each(function(){e(b,a(this),a(this).prev())}),e(b,a(),c.last())}),d},F=function(){e.create({type:e.types.CANCEL}).done(function(a){a.getRoot().on(f.hidden,function(){a.destroy(),x()}),a.setTitle(D(m.draggedElement)),a.getBody().append(E(a)),a.show()})};return{init:function(c){return"undefined"==typeof c.listSelector?void b.error("Parameter listSelector must be specified"):(c=a.extend({},j,k,c),a(c.listSelector).on("mousedown touchstart","> *",{params:c},q),void(null!==c.moveHandlerSelector&&a(c.listSelector).on("click",c.moveHandlerSelector,{params:c},s)))}}});